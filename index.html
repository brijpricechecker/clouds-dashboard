/**
 * Google Apps Script - Backend for Dashboard
 */

function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const masterSheet = ss.getSheetByName("Master");
  const salesSheet = ss.getSheetByName("Sales");
  const params = e.parameter;

  const selectedYear = params.year || new Date().getFullYear().toString();
  const selectedMonth = (params.month || "all").toLowerCase();

  const expenseData = masterSheet.getDataRange().getValues();
  const salesData = salesSheet.getDataRange().getValues();

  const header = expenseData[0];
  const monthIdx = header.indexOf("Month");
  const yearIdx = header.indexOf("Date");
  const amountIdx = header.indexOf("Amount");
  const categoryIdx = header.indexOf("Category");

  const salesHeader = salesData[0];
  const salesDateIdx = salesHeader.indexOf("Date");
  const salesAmountIdx = salesHeader.indexOf("Amount");

  const monthMap = {
    "january": 0, "february": 1, "march": 2, "april": 3,
    "may": 4, "june": 5, "july": 6, "august": 7,
    "september": 8, "october": 9, "november": 10, "december": 11
  };

  const targets = {
    foodandbeveragespurchases: 35,
    fixedexpense: 24,
    laborexpense: 18,
    operatingexpense: 8,
    misc: 5,
    profit: 10
  };

  const categoryMap = {
    "FOOD": "foodandbeveragespurchases",
    "LIQUOR": "foodandbeveragespurchases",
    "BEER": "foodandbeveragespurchases",
    "COFFEE": "foodandbeveragespurchases",
    "BAR CONSUMABLES": "foodandbeveragespurchases",

    "RENTAL EXPENSE": "fixedexpense",
    "RENTAL EXPENSE-STORAGE": "fixedexpense",
    "UTILITIES EXPENSE (ELECTRIC)": "fixedexpense",
    "UTILITIES EXPENSE (WATER)": "fixedexpense",
    "UTILITIES EXPENSE (INTERNET)": "fixedexpense",
    "UTILITIES EXPENSE (SOLANE)": "fixedexpense",
    "CONDOMINIUM ASSOC FEE": "fixedexpense",
    "REPAIRS AND MAINTENANCE": "fixedexpense",
    "MARKETING EXPENSE": "fixedexpense",
    "PENALTIES (OVERDUE RENTAL & UTILITIES)": "fixedexpense",

    "SALARIES AND WAGES": "laborexpense",
    "PREMIUM CONTRIBUTIONS(SSS,PHIC,PAGIBIG)": "laborexpense",

    "CLEANING SUPPLIES/ SANITATION & LAUNDRY": "operatingexpense",
    "DECORATIONS & IMPROVEMENTS": "operatingexpense",
    "KITCHEN EQUIPMENT": "operatingexpense",
    "BAR EQUIPMENT": "operatingexpense",
    "RESTAURANT SUPPLIES": "operatingexpense",
    "UNIFORMS": "operatingexpense",
    "OFFICE SUPPLIES": "operatingexpense",
    "TRANSPORTATION AND MEALS": "operatingexpense",
    "PERMITS & LICENSES": "operatingexpense",
    "LEGAL & PROFESSIONAL FEES": "operatingexpense",
    "INSURANCE (FIRE)": "operatingexpense",
    "OFFICE EQUIPMENT": "operatingexpense",
    "WASTAGE EXPENSE (OERA)": "operatingexpense",
    "BIR PENALTIES(QUARTERLY VAT) Late Filing": "operatingexpense",
    "PARKING FEES": "operatingexpense",
    "REPRESENTATION AND ALLOWANCES": "operatingexpense"
  };

  const monthlyCategoryTotals = {};
  const monthlyExpenseTotals = {};
  const monthlySales = {};
  let totalSales = 0;
  let totalExpenses = 0;

  const getMonthName = (date) => {
    return date.toLocaleDateString('en-US', { month: 'long' }).toLowerCase();
  };

  // Process sales
  for (let i = 1; i < salesData.length; i++) {
    const row = salesData[i];
    const date = new Date(row[salesDateIdx]);
    if (String(date.getFullYear()) !== selectedYear) continue;

    const monthName = getMonthName(date);
    const amount = parseFloat(row[salesAmountIdx]) || 0;
    monthlySales[monthName] = (monthlySales[monthName] || 0) + amount;
    if (selectedMonth === "all" || selectedMonth === monthName) {
      totalSales += amount;
    }
  }

  // Process expenses
  for (let i = 1; i < expenseData.length; i++) {
    const row = expenseData[i];
    const month = String(row[monthIdx]).toLowerCase();
    const date = new Date(row[yearIdx]);
    const year = date.getFullYear();
    if (String(year) !== selectedYear) continue;

    const category = String(row[categoryIdx] || "").trim().toUpperCase();
    const mapped = categoryMap[category] || "misc";
    const amount = parseFloat(row[amountIdx]) || 0;

    if (!monthlyCategoryTotals[month]) monthlyCategoryTotals[month] = {};
    monthlyCategoryTotals[month][mapped] = (monthlyCategoryTotals[month][mapped] || 0) + amount;
    monthlyExpenseTotals[month] = (monthlyExpenseTotals[month] || 0) + amount;

    if (selectedMonth === "all" || selectedMonth === month) {
      totalExpenses += amount;
    }
  }

  const totalRevenue = totalSales - totalExpenses;

  // P&L Table Data
  const pnlData = [];
  const monthList = Object.keys(monthlySales);

  const totalRow = {
    category: "Total"
  };

  for (let m of monthList) {
    totalRow[m] = monthlySales[m] - (monthlyExpenseTotals[m] || 0);
  }

  pnlData.push({ category: "Sales", ...monthlySales });
  pnlData.push({ category: "Expenses", ...monthlyExpenseTotals });
  pnlData.push(totalRow);

  return ContentService.createTextOutput(
    JSON.stringify({
      totalSales,
      totalExpenses,
      totalRevenue,
      monthlyCategoryTotals,
      monthlySales,
      monthlyExpenseTotals,
      targets,
      pnlData
    })
  ).setMimeType(ContentService.MimeType.JSON);
}
